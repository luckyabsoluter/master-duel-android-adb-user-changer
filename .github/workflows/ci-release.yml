name: CI and Release

on:
  push:
    branches:
      - "**"
    tags:
      - "v*"
  pull_request:
    branches:
      - "**"

permissions:
  contents: write

env:
  PROJECT_NAME: master-duel-android-adb-user-changer
  JAVA_VERSION_TAG: java25

jobs:
  build-matrix:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - windows-latest
          - ubuntu-latest
          - macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "25"

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: wrapper

      - name: Build
        shell: pwsh
        run: |
          if ($env:RUNNER_OS -eq "Windows") {
            .\gradlew.bat clean build
          } else {
            chmod +x ./gradlew
            ./gradlew clean build
          }

      - name: Prepare artifact files
        shell: pwsh
        run: |
          $osName = $env:RUNNER_OS.ToLower()
          New-Item -ItemType Directory -Force -Path ci-artifacts | Out-Null

          Get-ChildItem build/libs/*-all.jar | ForEach-Object {
            Copy-Item $_.FullName ("ci-artifacts/{0}-{1}-{2}.jar" -f $env:PROJECT_NAME, $env:JAVA_VERSION_TAG, $osName)
          }

      - name: Upload OS jar artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.PROJECT_NAME }}-${{ matrix.os }}-${{ github.run_id }}
          path: ci-artifacts/${{ env.PROJECT_NAME }}-${{ env.JAVA_VERSION_TAG }}-*.jar
          if-no-files-found: error

  build-universal-jar:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "25"

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: wrapper

      - name: Build universal jar
        run: |
          chmod +x ./gradlew
          ./gradlew clean universalShadowJar

      - name: Prepare universal artifact file
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path ci-universal | Out-Null
          Get-ChildItem build/libs/*-all-universal.jar | ForEach-Object {
            Copy-Item $_.FullName ("ci-universal/{0}-{1}-universal.jar" -f $env:PROJECT_NAME, $env:JAVA_VERSION_TAG)
          }

      - name: Upload universal jar artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.PROJECT_NAME }}-universal-${{ github.run_id }}
          path: ci-universal/${{ env.PROJECT_NAME }}-${{ env.JAVA_VERSION_TAG }}-universal.jar
          if-no-files-found: error

  release-on-tag:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    needs:
      - build-matrix
      - build-universal-jar
    runs-on: ubuntu-latest
    env:
      RELEASE_VERSION: ${{ github.ref_name }}
    steps:
      - name: Download OS jar artifacts
        uses: actions/download-artifact@v5
        with:
          pattern: ${{ env.PROJECT_NAME }}-*-${{ github.run_id }}
          path: release-files/os
          merge-multiple: true

      - name: Download universal jar artifact
        uses: actions/download-artifact@v5
        with:
          pattern: ${{ env.PROJECT_NAME }}-universal-${{ github.run_id }}
          path: release-files/universal
          merge-multiple: true

      - name: Prepare versioned release files
        run: |
          mkdir -p release-files/versioned
          cp "release-files/os/${PROJECT_NAME}-${JAVA_VERSION_TAG}-windows.jar" "release-files/versioned/${PROJECT_NAME}-${JAVA_VERSION_TAG}-${RELEASE_VERSION}-windows.jar"
          cp "release-files/os/${PROJECT_NAME}-${JAVA_VERSION_TAG}-linux.jar" "release-files/versioned/${PROJECT_NAME}-${JAVA_VERSION_TAG}-${RELEASE_VERSION}-linux.jar"
          cp "release-files/os/${PROJECT_NAME}-${JAVA_VERSION_TAG}-macos.jar" "release-files/versioned/${PROJECT_NAME}-${JAVA_VERSION_TAG}-${RELEASE_VERSION}-macos.jar"
          cp "release-files/universal/${PROJECT_NAME}-${JAVA_VERSION_TAG}-universal.jar" "release-files/versioned/${PROJECT_NAME}-${JAVA_VERSION_TAG}-${RELEASE_VERSION}-universal.jar"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.JAVA_VERSION_TAG }}-${{ env.RELEASE_VERSION }}-windows.jar
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.JAVA_VERSION_TAG }}-${{ env.RELEASE_VERSION }}-linux.jar
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.JAVA_VERSION_TAG }}-${{ env.RELEASE_VERSION }}-macos.jar
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.JAVA_VERSION_TAG }}-${{ env.RELEASE_VERSION }}-universal.jar
          generate_release_notes: true
