name: CI and Release

on:
  push:
    branches:
      - "**"
    tags:
      - "v*"
  pull_request:
    branches:
      - "**"

permissions:
  contents: write

env:
  PROJECT_NAME: master-duel-android-adb-user-changer
  JAVA_VERSION_TAG: java25

jobs:
  build-matrix:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - windows-latest
          - ubuntu-latest
          - macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "25"

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: wrapper

      - name: Build
        shell: pwsh
        run: |
          if ($env:RUNNER_OS -eq "Windows") {
            .\gradlew.bat clean build jpackageImage
          } else {
            chmod +x ./gradlew
            ./gradlew clean build jpackageImage
          }

      - name: Prepare artifact files
        shell: pwsh
        run: |
          $osName = $env:RUNNER_OS.ToLower()
          New-Item -ItemType Directory -Force -Path ci-artifacts | Out-Null

          Get-ChildItem build/libs/*-all.jar | ForEach-Object {
            Copy-Item $_.FullName ("ci-artifacts/{0}-{1}-{2}.jar" -f $env:PROJECT_NAME, $osName, $env:JAVA_VERSION_TAG)
          }

      - name: Upload OS jar artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.PROJECT_NAME }}-${{ matrix.os }}-jar-${{ github.run_id }}
          path: ci-artifacts/${{ env.PROJECT_NAME }}-*-${{ env.JAVA_VERSION_TAG }}.jar
          if-no-files-found: error

      - name: Prepare native artifact file
        shell: pwsh
        run: |
          $osName = $env:RUNNER_OS.ToLower()
          New-Item -ItemType Directory -Force -Path ci-native | Out-Null

          $nativeSource = Get-ChildItem build/jpackage | Select-Object -First 1
          if ($null -eq $nativeSource) {
            throw "Native app-image not found under build/jpackage."
          }

          $nativeZip = ("ci-native/{0}-{1}-native.zip" -f $env:PROJECT_NAME, $osName)
          if ($nativeSource.PSIsContainer) {
            $nativeSourcePattern = Join-Path $nativeSource.FullName '*'
            Compress-Archive -Path $nativeSourcePattern -DestinationPath $nativeZip -Force
          } else {
            Compress-Archive -Path $nativeSource.FullName -DestinationPath $nativeZip -Force
          }

      - name: Upload native artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.PROJECT_NAME }}-${{ matrix.os }}-native-${{ github.run_id }}
          path: ci-native/${{ env.PROJECT_NAME }}-*-native.zip
          if-no-files-found: error

  build-gluonfx-native:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - windows-latest
          - ubuntu-latest
          - macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup GraalVM built by Gluon
        uses: gluonhq/setup-graalvm@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: wrapper

      - name: Build GluonFX native image
        shell: pwsh
        run: |
          if ($env:RUNNER_OS -eq "Windows") {
            $buildPath = "C:\workspace-gluonfx-src"
            if (Test-Path $buildPath) {
              Remove-Item -Recurse -Force $buildPath
            }
            New-Item -ItemType Directory -Force -Path $buildPath | Out-Null
            robocopy $env:GITHUB_WORKSPACE $buildPath /E /NFL /NDL /NJH /NJS /NP /XD ".git" | Out-Null
            if ($LASTEXITCODE -gt 7) {
              throw "robocopy failed with exit code $LASTEXITCODE."
            }

            Push-Location $buildPath
            $env:GRAALVM_HOME = $env:JAVA_HOME
            .\gradlew.bat clean nativeBuild
            Pop-Location

            New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE\ci-gluonfx" | Out-Null
            $nativeBin = Get-ChildItem "$buildPath\build\gluonfx" -Recurse -File |
              Where-Object { $_.Name -eq "$env:PROJECT_NAME.exe" } |
              Select-Object -First 1
            if ($null -eq $nativeBin) {
              throw "GluonFX native executable not found under $buildPath\build\gluonfx."
            }
            Copy-Item $nativeBin.FullName "$env:GITHUB_WORKSPACE\ci-gluonfx\$env:PROJECT_NAME-windows-gluonfx.exe" -Force
          } else {
            chmod +x ./gradlew
            $env:GRAALVM_HOME = $env:JAVA_HOME
            ./gradlew clean nativeBuild
          }

      - name: Prepare GluonFX artifact file
        shell: pwsh
        run: |
          if ($env:RUNNER_OS -eq "Windows") {
            Write-Host "Windows artifact already prepared during C: drive build."
            exit 0
          }

          $osName = $env:RUNNER_OS.ToLower()
          New-Item -ItemType Directory -Force -Path ci-gluonfx | Out-Null

          $nativeBin = Get-ChildItem "build/gluonfx" -Recurse -File |
            Where-Object { $_.Name -eq $env:PROJECT_NAME } |
            Select-Object -First 1
          if ($null -eq $nativeBin) {
            throw "GluonFX native executable not found under build/gluonfx."
          }

          $artifactPath = "ci-gluonfx/{0}-{1}-gluonfx{2}" -f $env:PROJECT_NAME, $osName, $nativeBin.Extension
          Copy-Item $nativeBin.FullName $artifactPath -Force

      - name: Upload GluonFX artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.PROJECT_NAME }}-${{ matrix.os }}-gluonfx-${{ github.run_id }}
          path: ci-gluonfx/${{ env.PROJECT_NAME }}-*-gluonfx*
          if-no-files-found: error

  build-universal-jar:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "25"

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: wrapper

      - name: Build universal jar
        run: |
          chmod +x ./gradlew
          ./gradlew clean universalShadowJar

      - name: Prepare universal artifact file
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path ci-universal | Out-Null
          Get-ChildItem build/libs/*-all-universal.jar | ForEach-Object {
            Copy-Item $_.FullName ("ci-universal/{0}-universal-{1}.jar" -f $env:PROJECT_NAME, $env:JAVA_VERSION_TAG)
          }

      - name: Upload universal jar artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.PROJECT_NAME }}-universal-jar-${{ github.run_id }}
          path: ci-universal/${{ env.PROJECT_NAME }}-universal-${{ env.JAVA_VERSION_TAG }}.jar
          if-no-files-found: error

  release-on-tag:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    needs:
      - build-matrix
      - build-universal-jar
      - build-gluonfx-native
    runs-on: ubuntu-latest
    env:
      RELEASE_VERSION: ${{ github.ref_name }}
    steps:
      - name: Download OS jar artifacts
        uses: actions/download-artifact@v5
        with:
          pattern: ${{ env.PROJECT_NAME }}-*-jar-${{ github.run_id }}
          path: release-files/os
          merge-multiple: true

      - name: Download universal jar artifact
        uses: actions/download-artifact@v5
        with:
          pattern: ${{ env.PROJECT_NAME }}-universal-jar-${{ github.run_id }}
          path: release-files/universal
          merge-multiple: true

      - name: Download native artifacts
        uses: actions/download-artifact@v5
        with:
          pattern: ${{ env.PROJECT_NAME }}-*-native-${{ github.run_id }}
          path: release-files/native
          merge-multiple: true

      - name: Download GluonFX artifact
        uses: actions/download-artifact@v5
        with:
          pattern: ${{ env.PROJECT_NAME }}-*-gluonfx-${{ github.run_id }}
          path: release-files/gluonfx
          merge-multiple: true

      - name: Prepare versioned release files
        run: |
          mkdir -p release-files/versioned
          cp "release-files/os/${PROJECT_NAME}-windows-${JAVA_VERSION_TAG}.jar" "release-files/versioned/${PROJECT_NAME}-${RELEASE_VERSION}-windows-${JAVA_VERSION_TAG}.jar"
          cp "release-files/os/${PROJECT_NAME}-linux-${JAVA_VERSION_TAG}.jar" "release-files/versioned/${PROJECT_NAME}-${RELEASE_VERSION}-linux-${JAVA_VERSION_TAG}.jar"
          cp "release-files/os/${PROJECT_NAME}-macos-${JAVA_VERSION_TAG}.jar" "release-files/versioned/${PROJECT_NAME}-${RELEASE_VERSION}-macos-${JAVA_VERSION_TAG}.jar"
          cp "release-files/universal/${PROJECT_NAME}-universal-${JAVA_VERSION_TAG}.jar" "release-files/versioned/${PROJECT_NAME}-${RELEASE_VERSION}-universal-${JAVA_VERSION_TAG}.jar"
          cp "release-files/native/${PROJECT_NAME}-windows-native.zip" "release-files/versioned/${PROJECT_NAME}-${RELEASE_VERSION}-windows-native.zip"
          cp "release-files/native/${PROJECT_NAME}-linux-native.zip" "release-files/versioned/${PROJECT_NAME}-${RELEASE_VERSION}-linux-native.zip"
          cp "release-files/native/${PROJECT_NAME}-macos-native.zip" "release-files/versioned/${PROJECT_NAME}-${RELEASE_VERSION}-macos-native.zip"
          cp "release-files/gluonfx/${PROJECT_NAME}-windows-gluonfx.exe" "release-files/versioned/${PROJECT_NAME}-${RELEASE_VERSION}-windows-gluonfx.exe"
          cp "release-files/gluonfx/${PROJECT_NAME}-linux-gluonfx" "release-files/versioned/${PROJECT_NAME}-${RELEASE_VERSION}-linux-gluonfx"
          cp "release-files/gluonfx/${PROJECT_NAME}-macos-gluonfx" "release-files/versioned/${PROJECT_NAME}-${RELEASE_VERSION}-macos-gluonfx"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.RELEASE_VERSION }}-windows-${{ env.JAVA_VERSION_TAG }}.jar
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.RELEASE_VERSION }}-linux-${{ env.JAVA_VERSION_TAG }}.jar
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.RELEASE_VERSION }}-macos-${{ env.JAVA_VERSION_TAG }}.jar
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.RELEASE_VERSION }}-universal-${{ env.JAVA_VERSION_TAG }}.jar
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.RELEASE_VERSION }}-windows-native.zip
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.RELEASE_VERSION }}-linux-native.zip
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.RELEASE_VERSION }}-macos-native.zip
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.RELEASE_VERSION }}-windows-gluonfx.exe
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.RELEASE_VERSION }}-linux-gluonfx
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.RELEASE_VERSION }}-macos-gluonfx
          generate_release_notes: true
