name: CI and Release

on:
  push:
    branches:
      - "**"
    tags:
      - "v*"
  pull_request:
    branches:
      - "**"

permissions:
  contents: write

jobs:
  build-matrix:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - windows-latest
          - ubuntu-latest
          - macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "25"
          cache: gradle

      - name: Build
        shell: pwsh
        run: |
          if ($env:RUNNER_OS -eq "Windows") {
            .\gradlew.bat clean build
          } else {
            chmod +x ./gradlew
            ./gradlew clean build
          }

      - name: Prepare artifact files
        shell: pwsh
        run: |
          $osName = $env:RUNNER_OS.ToLower()
          New-Item -ItemType Directory -Force -Path ci-artifacts | Out-Null

          Get-ChildItem build/libs/*-all.jar | ForEach-Object {
            Copy-Item $_.FullName ("ci-artifacts/{0}-{1}" -f $osName, $_.Name)
          }

      - name: Upload platform all jar artifact
        uses: actions/upload-artifact@v6
        with:
          name: platform-all-jar-${{ matrix.os }}-${{ github.run_id }}
          path: ci-artifacts/*-all.jar
          if-no-files-found: error

  build-universal-fat-jar:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "25"
          cache: gradle

      - name: Build universal fat jar
        run: |
          chmod +x ./gradlew
          ./gradlew clean universalShadowJar

      - name: Upload universal fat jar artifact
        uses: actions/upload-artifact@v6
        with:
          name: universal-fat-jar-${{ github.run_id }}
          path: build/libs/*-all-universal.jar
          if-no-files-found: error

  release-on-tag:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    needs:
      - build-matrix
      - build-universal-fat-jar
    runs-on: ubuntu-latest
    steps:
      - name: Download platform all jar artifacts
        uses: actions/download-artifact@v5
        with:
          pattern: platform-all-jar-*-${{ github.run_id }}
          path: release-files/platform
          merge-multiple: true

      - name: Download universal fat jar artifact
        uses: actions/download-artifact@v5
        with:
          pattern: universal-fat-jar-${{ github.run_id }}
          path: release-files/fat
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-files/platform/*-all.jar
            release-files/fat/*-all-universal.jar
          generate_release_notes: true
