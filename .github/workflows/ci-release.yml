name: CI and Release

on:
  push:
    branches:
      - "**"
    tags:
      - "v*"
  pull_request:
    branches:
      - "**"

permissions:
  contents: write

env:
  PROJECT_NAME: master-duel-android-adb-user-changer
  JAVA_VERSION_TAG: java25

jobs:
  build-matrix:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - windows-latest
          - ubuntu-latest
          - macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "25"

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: wrapper

      - name: Build
        shell: pwsh
        run: |
          if ($env:RUNNER_OS -eq "Windows") {
            .\gradlew.bat clean build jpackageImage
          } else {
            chmod +x ./gradlew
            ./gradlew clean build jpackageImage
          }

      - name: Prepare artifact files
        shell: pwsh
        run: |
          $osName = $env:RUNNER_OS.ToLower()
          New-Item -ItemType Directory -Force -Path ci-artifacts | Out-Null

          Get-ChildItem build/libs/*-all.jar | ForEach-Object {
            Copy-Item $_.FullName ("ci-artifacts/{0}-{1}-{2}.jar" -f $env:PROJECT_NAME, $osName, $env:JAVA_VERSION_TAG)
          }

      - name: Upload OS jar artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.PROJECT_NAME }}-${{ matrix.os }}-jar-${{ github.run_id }}
          path: ci-artifacts/${{ env.PROJECT_NAME }}-*-${{ env.JAVA_VERSION_TAG }}.jar
          if-no-files-found: error

      - name: Prepare native artifact file
        shell: pwsh
        run: |
          $osName = $env:RUNNER_OS.ToLower()
          New-Item -ItemType Directory -Force -Path ci-native | Out-Null

          $nativeSource = Get-ChildItem build/jpackage | Select-Object -First 1
          if ($null -eq $nativeSource) {
            throw "Native app-image not found under build/jpackage."
          }

          $nativeZip = ("ci-native/{0}-{1}-native.zip" -f $env:PROJECT_NAME, $osName)
          if ($nativeSource.PSIsContainer) {
            $nativeSourcePattern = Join-Path $nativeSource.FullName '*'
            Compress-Archive -Path $nativeSourcePattern -DestinationPath $nativeZip -Force
          } else {
            Compress-Archive -Path $nativeSource.FullName -DestinationPath $nativeZip -Force
          }

      - name: Upload native artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.PROJECT_NAME }}-${{ matrix.os }}-native-${{ github.run_id }}
          path: ci-native/${{ env.PROJECT_NAME }}-*-native.zip
          if-no-files-found: error

  build-graal-native:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - windows-latest
          - ubuntu-latest
          - macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up GraalVM JDK 25
        uses: graalvm/setup-graalvm@v1
        with:
          distribution: graalvm-community
          java-version: "25"
          github-token: ${{ secrets.GITHUB_TOKEN }}
          native-image-job-reports: "true"

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: wrapper

      - name: Build GraalVM native image
        shell: pwsh
        run: |
          if ($env:RUNNER_OS -eq "Windows") {
            .\gradlew.bat clean nativeCompile
          } else {
            chmod +x ./gradlew
            ./gradlew clean nativeCompile
          }

      - name: Prepare Graal artifact file
        shell: pwsh
        run: |
          $osName = $env:RUNNER_OS.ToLower()
          New-Item -ItemType Directory -Force -Path ci-graal | Out-Null

          $nativeBin = Get-ChildItem "build/native/nativeCompile/${env:PROJECT_NAME}*" -File | Select-Object -First 1
          if ($null -eq $nativeBin) {
            throw "Graal native executable not found under build/native/nativeCompile."
          }

          $zipPath = "ci-graal/{0}-{1}-graal.zip" -f $env:PROJECT_NAME, $osName
          Compress-Archive -Path $nativeBin.FullName -DestinationPath $zipPath -Force

      - name: Upload Graal artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.PROJECT_NAME }}-${{ matrix.os }}-graal-${{ github.run_id }}
          path: ci-graal/${{ env.PROJECT_NAME }}-*-graal.zip
          if-no-files-found: error

  build-universal-jar:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "25"

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: wrapper

      - name: Build universal jar
        run: |
          chmod +x ./gradlew
          ./gradlew clean universalShadowJar

      - name: Prepare universal artifact file
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path ci-universal | Out-Null
          Get-ChildItem build/libs/*-all-universal.jar | ForEach-Object {
            Copy-Item $_.FullName ("ci-universal/{0}-universal-{1}.jar" -f $env:PROJECT_NAME, $env:JAVA_VERSION_TAG)
          }

      - name: Upload universal jar artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.PROJECT_NAME }}-universal-jar-${{ github.run_id }}
          path: ci-universal/${{ env.PROJECT_NAME }}-universal-${{ env.JAVA_VERSION_TAG }}.jar
          if-no-files-found: error

  release-on-tag:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    needs:
      - build-matrix
      - build-universal-jar
      - build-graal-native
    runs-on: ubuntu-latest
    env:
      RELEASE_VERSION: ${{ github.ref_name }}
    steps:
      - name: Download OS jar artifacts
        uses: actions/download-artifact@v5
        with:
          pattern: ${{ env.PROJECT_NAME }}-*-jar-${{ github.run_id }}
          path: release-files/os
          merge-multiple: true

      - name: Download universal jar artifact
        uses: actions/download-artifact@v5
        with:
          pattern: ${{ env.PROJECT_NAME }}-universal-jar-${{ github.run_id }}
          path: release-files/universal
          merge-multiple: true

      - name: Download native artifacts
        uses: actions/download-artifact@v5
        with:
          pattern: ${{ env.PROJECT_NAME }}-*-native-${{ github.run_id }}
          path: release-files/native
          merge-multiple: true

      - name: Download Graal artifact
        uses: actions/download-artifact@v5
        with:
          pattern: ${{ env.PROJECT_NAME }}-*-graal-${{ github.run_id }}
          path: release-files/graal
          merge-multiple: true

      - name: Prepare versioned release files
        run: |
          mkdir -p release-files/versioned
          cp "release-files/os/${PROJECT_NAME}-windows-${JAVA_VERSION_TAG}.jar" "release-files/versioned/${PROJECT_NAME}-${RELEASE_VERSION}-windows-${JAVA_VERSION_TAG}.jar"
          cp "release-files/os/${PROJECT_NAME}-linux-${JAVA_VERSION_TAG}.jar" "release-files/versioned/${PROJECT_NAME}-${RELEASE_VERSION}-linux-${JAVA_VERSION_TAG}.jar"
          cp "release-files/os/${PROJECT_NAME}-macos-${JAVA_VERSION_TAG}.jar" "release-files/versioned/${PROJECT_NAME}-${RELEASE_VERSION}-macos-${JAVA_VERSION_TAG}.jar"
          cp "release-files/universal/${PROJECT_NAME}-universal-${JAVA_VERSION_TAG}.jar" "release-files/versioned/${PROJECT_NAME}-${RELEASE_VERSION}-universal-${JAVA_VERSION_TAG}.jar"
          cp "release-files/native/${PROJECT_NAME}-windows-native.zip" "release-files/versioned/${PROJECT_NAME}-${RELEASE_VERSION}-windows-native.zip"
          cp "release-files/native/${PROJECT_NAME}-linux-native.zip" "release-files/versioned/${PROJECT_NAME}-${RELEASE_VERSION}-linux-native.zip"
          cp "release-files/native/${PROJECT_NAME}-macos-native.zip" "release-files/versioned/${PROJECT_NAME}-${RELEASE_VERSION}-macos-native.zip"
          cp "release-files/graal/${PROJECT_NAME}-windows-graal.zip" "release-files/versioned/${PROJECT_NAME}-${RELEASE_VERSION}-windows-graal.zip"
          cp "release-files/graal/${PROJECT_NAME}-linux-graal.zip" "release-files/versioned/${PROJECT_NAME}-${RELEASE_VERSION}-linux-graal.zip"
          cp "release-files/graal/${PROJECT_NAME}-macos-graal.zip" "release-files/versioned/${PROJECT_NAME}-${RELEASE_VERSION}-macos-graal.zip"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.RELEASE_VERSION }}-windows-${{ env.JAVA_VERSION_TAG }}.jar
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.RELEASE_VERSION }}-linux-${{ env.JAVA_VERSION_TAG }}.jar
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.RELEASE_VERSION }}-macos-${{ env.JAVA_VERSION_TAG }}.jar
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.RELEASE_VERSION }}-universal-${{ env.JAVA_VERSION_TAG }}.jar
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.RELEASE_VERSION }}-windows-native.zip
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.RELEASE_VERSION }}-linux-native.zip
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.RELEASE_VERSION }}-macos-native.zip
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.RELEASE_VERSION }}-windows-graal.zip
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.RELEASE_VERSION }}-linux-graal.zip
            release-files/versioned/${{ env.PROJECT_NAME }}-${{ env.RELEASE_VERSION }}-macos-graal.zip
          generate_release_notes: true
